<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./style.css" />
  </head>

  <body>
    <div class="container">
      <div class="title">Repo Report!</div>
      <div class="instructions">
        <div class="instructions-content">Enter Command and press Enter!</div>
        <div id="status" class="status-hide">
          <div class="loader" id="status-loader">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>
          <div class="status-text" id="status-text"></div>
        </div>
      </div>

      <input class="command" type="text" name="command" id="command" />
      <div class="table-container">
        <table class="table" cellspacing="0" cellpadding="0">
          <thead id="table-head" class="table-head"></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
      const executeCommand = async (command) => {
        try {
          const res = await axios.post("/command", {
            command: command,
          })
          return res.data.output
        } catch (e) {
          return e.response.data
        }
      }

      const handleInput = async (event) => {
        if (event.keyCode === 13) {
          event.preventDefault()
          showStatus()
          clearTable()
          const response = await executeCommand(input.value)
          hidestatus()
          if (response.success === 0) {
            showError(response.msg)
          } else {
            renderHead(response.metrics)
            renderBody(response.repos, response.rows)
          }
        }
      }

      const clearTable = () => {
        const tableHead = document.getElementById("table-head")
        const tableBody = document.getElementById("table-body")

        while (tableHead.firstChild) {
          tableHead.firstChild.remove()
        }
        while (tableBody.firstChild) {
          tableBody.firstChild.remove()
        }
      }

      const showError = (error) => {
        let status = document.getElementById("status")
        let statusLoader = document.getElementById("status-loader")
        let statusText = document.getElementById("status-text")
        // set the error text
        statusText.innerText = error
        // hide the loader
        statusLoader.classList.remove("loader")
        statusLoader.classList.add("status-hide")
        // make status visible
        status.classList.remove("status-hide")
        status.classList.add("status-error")
      }

      const showStatus = () => {
        let status = document.getElementById("status")
        let statusLoader = document.getElementById("status-loader")
        let statusText = document.getElementById("status-text")
        // set the status text
        statusText.innerText = "Getting Data from Github..."
        // make the loader visible
        statusLoader.classList.remove("status-hide")
        statusLoader.classList.add("loader")
        // make status visible
        status.classList.remove("status-hide")
        status.classList.remove("status-error")
        status.classList.add("status")
      }

      const hidestatus = () => {
        let status = document.getElementById("status")
        status.classList.remove("status")
        status.classList.remove("status-error")
        status.classList.add("status-hide")
      }

      const renderBody = (repos, rows) => {
        let tableBody = document.getElementById("table-body")
        repos.forEach((repo, i) => {
          const row = rows[i]
          let tr = document.createElement("tr")

          let left = document.createElement("td")
          left.innerHTML = repo
          tr.appendChild(left)

          row.forEach((elem) => {
            let td = document.createElement("td")
            let tdContainer = document.createElement("div")
            tdContainer.classList.add("td-container")

            let div = document.createElement("div")
            if (elem === 1) {
              div.classList.add("circle-green")
            } else {
              div.classList.add("circle-red")
            }
            tdContainer.appendChild(div)
            td.appendChild(tdContainer)
            tr.appendChild(td)
          })
          tableBody.appendChild(tr)
        })
      }
      const renderHead = (head) => {
        let headTable = document.getElementById("table-head")
        let tr = document.createElement("tr")
        headTable.appendChild(tr)

        let th = document.createElement("th")
        th.textContent = "Repositories/Metrics"
        tr.appendChild(th)

        head.forEach((element) => {
          let th = document.createElement("th")
          th.textContent = element
          tr.appendChild(th)
        })
      }

      let input = document.getElementById("command")
      input.addEventListener("keyup", handleInput)
    </script>
  </body>
</html>
